{% extends "base.html" %}
{% load i18n static js %}

{% block page_title %}
{% trans 'デザインカスタマイズ' %}
{% endblock page_title %}

{% block content %}
<style>
    .dg .c select {
        background-color: rgb(48, 48, 48);
        height: 27px;
    }

    .dg .c input[type=text] {
        height: 27px;
        line-height: 27px;
    }
</style>
<div id="blur" class="hidden flex items-center justify-center"
    style="position: fixed; top:0; left: 0; width: 100vw; height: 100vh; background: rgba(10, 10, 10, 0.9); z-index: 1000;">
    <span class="text-4xl font-bold text-gray-300">画像を抽出しています。</span>
</div>
<div class="mx-auto w-full min-h-75vh">
    <form method="POST" id="main-form">
        {% csrf_token %}
        <div id="screen" class="w-full h-75vh relative">
            <div id="guiContainer" class="absolute" style="right: 0px;"></div>
            <button class="btn w-64 absolute" style="bottom: 1rem; right: 1rem;">{% trans 'デザイン確定' %}</button>
        </div>
        {{ form }}
    </form>
    <div class="w-full flex">
        <div class="w-12 bg-gray-300">
            <a href="" id="prev_page" class="hidden w-full block h-56 flex items-center justify-center">
                <i class="fas fa-chevron-left fa-2x"></i>
            </a>
        </div>
        <ul id="design_list" class="w-full h-56 flex">
            {% include 'mixins/designs/related_design_card.html' %}
        </ul>
        <div class="w-12 bg-gray-300">
            {% if page_obj.has_next %}
            <a href="" id="next_page" class="w-full block h-56 flex items-center justify-center">
                <i class="fas fa-chevron-right fa-2x"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>


{% endblock content %}

{% block javascript %}
<script src="{% static 'js/three.min.js' %}"></script>
<script src="{% static 'js/OrbitControls.js' %}"></script>
<script src="{% static 'js/GLTFLoader.js' %}"></script>
<script src="{% static 'js/dat.gui.min.js' %}"></script>
<script>
    // three.js 環境設定
    var gui, jar;
    var scene = new THREE.Scene();
    var screen = document.getElementById("screen");

    var renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.shadowMap.enabled = true;
    renderer.setSize(screen.clientWidth, screen.clientHeight);
    renderer.setClearColor(0xeeeee4, 1);
    renderer.shadowMap.Type = THREE.PCFSoftShadowMap;
    screen.appendChild(renderer.domElement);

    // 操作用カメラ設定
    var camera = new THREE.PerspectiveCamera(90, screen.clientWidth / screen.clientHeight, 1, 1000);
    camera.aspect = screen.clientWidth / screen.clientHeight;
    camera.updateProjectionMatrix();
    camera.position.z = 4;

    window.addEventListener('resize', function () {
        var width = screen.clientWidth;
        var height = screen.clientHeight;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
    });


    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.minDistance = 3.2;
    controls.maxDistance = 5;

    var loader = new THREE.GLTFLoader();


    // デザインカスタマイズ用テンプレートのロード
    var shoelace_left_data, tongue_left_data, upper_left_data, midsole_left_data, outsole_left_data, liner_left_data, shoelace_right_data, tongue_right_data, upper_right_data, midsole_right_data, outsole_right_data, liner_right_data;

    {% if template.shoelace_left %}
    shoelace_left_data = "{{ template.shoelace_left.url }}";
    {% endif %}
    {% if template.tongue_left %}
    tongue_left_data = "{{ template.tongue_left.url }}";
    {% endif %}
    {% if template.upper_left %}
    upper_left_data = "{{ template.upper_left.url }}";
    {% endif %}
    {% if template.midsole_left %}
    midsole_left_data = "{{ template.midsole_left.url }}";
    {% endif %}
    {% if template.outsole_left %}
    outsole_left_data = "{{ template.outsole_left.url }}";
    {% endif %}
    {% if template.liner_left %}
    liner_left_data = "{{ template.liner_left.url }}";
    {% endif %}
    {% if template.shoelace_right %}
    shoelace_right_data = "{{ template.shoelace_right.url }}";
    {% endif %}
    {% if template.tongue_right %}
    tongue_right_data = "{{ template.tongue_right.url }}";
    {% endif %}
    {% if template.upper_right %}
    upper_right_data = "{{ template.upper_right.url }}";
    {% endif %}
    {% if template.midsole_right %}
    midsole_right_data = "{{ template.midsole_right.url }}";
    {% endif %}
    {% if template.outsole_right %}
    outsole_right_data = "{{ template.outsole_right.url }}";
    {% endif %}
    {% if template.liner_right %}
    liner_right_data = "{{ template.liner_right.url }}";
    {% endif %}

    if (shoelace_left_data) {
        loader.load(shoelace_left_data, load_left_shoelace);
    }
    var left_shoelace;
    function load_left_shoelace(gltf) {
        left_shoelace = gltf.scene.children[0];
        left_shoelace.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.shoelace_color_left }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.shoelace_material_left.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        left_shoelace.material.pk = "{% if design_before %}{{ design_before.shoelace_material_left.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(left_shoelace);
    }

    if (tongue_left_data) {
        loader.load(tongue_left_data, load_left_tongue);
    }
    var left_tongue;
    function load_left_tongue(gltf) {
        left_tongue = gltf.scene.children[0];
        left_tongue.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.tongue_color_left }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.tongue_material_left.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        left_tongue.material.pk = "{% if design_before %}{{ design_before.tongue_material_left.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(left_tongue);
    }

    if (upper_left_data) {
        loader.load(upper_left_data, load_left_upper);
    }
    var left_upper;
    function load_left_upper(gltf) {
        left_upper = gltf.scene.children[0];
        left_upper.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.uppersole_color_left }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.uppersole_material_left.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        left_upper.material.pk = "{% if design_before %}{{ design_before.uppersole_material_left.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(left_upper);
    }

    if (midsole_left_data) {
        loader.load(midsole_left_data, load_left_bottom);
    }
    var left_bottom;
    function load_left_bottom(gltf) {
        left_bottom = gltf.scene.children[0];
        left_bottom.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.midsole_color_left }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.midsole_material_left.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        left_bottom.material.pk = "{% if design_before %}{{ design_before.midsole_material_left.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(left_bottom);
    }

    if (outsole_left_data) {
        loader.load(outsole_left_data, load_left_sole);
    }
    var left_sole;
    function load_left_sole(gltf) {
        left_sole = gltf.scene.children[0];
        left_sole.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.outsole_color_left }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.outsole_material_left.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        left_sole.material.pk = "{% if design_before %}{{ design_before.outsole_material_left.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(left_sole);
    }


    if (shoelace_right_data) {
        loader.load(shoelace_right_data, load_right_shoelace);
    }
    var right_shoelace;
    function load_right_shoelace(gltf) {
        right_shoelace = gltf.scene.children[0];
        right_shoelace.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.shoelace_color_right }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.shoelace_material_right.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        right_shoelace.material.pk = "{% if design_before %}{{ design_before.shoelace_material_right.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(right_shoelace);
    }

    if (tongue_right_data) {
        loader.load(tongue_right_data, load_right_tongue);
    }
    var right_tongue;
    function load_right_tongue(gltf) {
        right_tongue = gltf.scene.children[0];
        right_tongue.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.tongue_color_right }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.tongue_material_right.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        right_tongue.material.pk = "{% if design_before %}{{ design_before.tongue_material_right.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(right_tongue);
    }

    if (upper_right_data) {
        loader.load(upper_right_data, load_right_upper);
    }
    var right_upper;
    function load_right_upper(gltf) {
        right_upper = gltf.scene.children[0];
        right_upper.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.uppersole_color_right }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.uppersole_material_right.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        right_upper.material.pk = "{% if design_before %}{{ design_before.uppersole_material_right.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(right_upper);
    }

    if (midsole_right_data) {
        loader.load(midsole_right_data, load_right_bottom);
    }
    var right_bottom;
    function load_right_bottom(gltf) {
        right_bottom = gltf.scene.children[0];
        right_bottom.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.midsole_color_right }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.midsole_material_right.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        right_bottom.material.pk = "{% if design_before %}{{ design_before.midsole_material_right.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(right_bottom);
    }

    var right_sole;
    if (outsole_right_data) {
        loader.load(outsole_right_data, load_right_sole);
    }
    function load_right_sole(gltf) {
        right_sole = gltf.scene.children[0];
        right_sole.material = new THREE.MeshPhongMaterial({ color: "{% if design_before %}{{ design_before.outsole_color_right }}{% else %}#ffffff{% endif %}", map: new THREE.TextureLoader().load('{% if design_before %}{{ design_before.outsole_material_right.file.url }}{% else %}{{ mat1.file.url }}{% endif %}'), side: THREE.DoubleSide });
        right_sole.material.pk = "{% if design_before %}{{ design_before.outsole_material_right.pk }}{% else %}{{ mat1.pk }}{% endif %}";
        scene.add(right_sole);
    }

    var gui = new dat.GUI();

    // GUIの設定
    function displaygui() {
        parameters = {
            // 左足の色のデフォルト値
            d: "#ffffff",
            e: "#ffffff",
            f: "#ffffff",
            g: "#ffffff",
            h: "#ffffff",

            // 右足の色のデフォルト値
            i: "#ffffff",
            j: "#ffffff",
            k: "#ffffff",
            l: "#ffffff",
            m: "#ffffff",

            // 左足の素材のデフォルト値
            n: "{{ mat1.name }}",
            o: "{{ mat1.name }}",
            p: "{{ mat1.name }}",
            q: "{{ mat1.name }}",
            r: "{{ mat1.name }}",

            // 右足の素材のデフォルト値
            s: "{{ mat1.name }}",
            t: "{{ mat1.name }}",
            u: "{{ mat1.name }}",
            v: "{{ mat1.name }}",
            w: "{{ mat1.name }}",
        }

        // 左足の色
        var left = gui.addFolder('{% trans "色(左)" %}');
        var l_shoelace = left.addColor(parameters, 'd').name('{% trans "シューレス" %}');
        var l_upper = left.addColor(parameters, 'e').name('{% trans "アッパーソール" %}');
        var l_tongue = left.addColor(parameters, 'f').name('{% trans "タン" %}');
        var l_bottom = left.addColor(parameters, 'g').name('{% trans "ミッドソール" %}');
        var l_sole = left.addColor(parameters, 'h').name('{% trans "アウトソール" %}');

        // 右足の色
        var right = gui.addFolder('{% trans "色(右)" %}');
        var r_shoelace = right.addColor(parameters, 'i').name('{% trans "シューレス" %}');
        var r_upper = right.addColor(parameters, 'j').name('{% trans "アッパーソール" %}');
        var r_tongue = right.addColor(parameters, 'k').name('{% trans "タン" %}');
        var r_bottom = right.addColor(parameters, 'l').name('{% trans "ミッドソール" %}');
        var r_sole = right.addColor(parameters, 'm').name('{% trans "アウトソール" %}');

        // 左足の素材
        var left_m = gui.addFolder('{% trans "素材(左)" %}');
        var lm_shoelace = left_m.add(parameters, 'n', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "シューレス" %}');
        var lm_upper = left_m.add(parameters, 'o', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "アッパーソール" %}');
        var lm_tongue = left_m.add(parameters, 'p', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "タン" %}');
        var lm_bottom = left_m.add(parameters, 'q', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "ミッドソール" %}');
        var lm_sole = left_m.add(parameters, 'r', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "アウトソール" %}');

        // 右足の素材
        var right_m = gui.addFolder('{% trans "素材(右)" %}');
        var rm_shoelace = right_m.add(parameters, 's', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "シューレス" %}');
        var rm_upper = right_m.add(parameters, 't', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "アッパーソール" %}');
        var rm_tongue = right_m.add(parameters, 'u', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "タン" %}');
        var rm_bottom = right_m.add(parameters, 'v', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "ミッドソール" %}');
        var rm_sole = right_m.add(parameters, 'w', ["{{ mat1.name }}", "{{ mat2.name }}", "{{ mat3.name }}"]).name('{% trans "アウトソール" %}');

        // 左足の色の変更時の処理
        l_shoelace.onChange(function (jar) {
            left_shoelace.material.color.setHex(jar.replace("#", "0x"));
        });
        l_upper.onChange(function (jar) {
            left_upper.material.color.setHex(jar.replace("#", "0x"));
        });
        l_tongue.onChange(function (jar) {
            left_tongue.material.color.setHex(jar.replace("#", "0x"));
        });
        l_bottom.onChange(function (jar) {
            left_bottom.material.color.setHex(jar.replace("#", "0x"));
        });
        l_sole.onChange(function (jar) {
            left_sole.material.color.setHex(jar.replace("#", "0x"));
        });

        // 右足の色の変更時の処理
        r_shoelace.onChange(function (jar) {
            right_shoelace.material.color.setHex(jar.replace("#", "0x"));
        });
        r_upper.onChange(function (jar) {
            right_upper.material.color.setHex(jar.replace("#", "0x"));
        });
        r_tongue.onChange(function (jar) {
            right_tongue.material.color.setHex(jar.replace("#", "0x"));
        });
        r_bottom.onChange(function (jar) {
            right_bottom.material.color.setHex(jar.replace("#", "0x"));
        });
        r_sole.onChange(function (jar) {
            right_sole.material.color.setHex(jar.replace("#", "0x"));
        });

        // 左足の素材の変更時の処理
        lm_shoelace.onChange(function (jar) {
            var left_shoelace_material = lm_shoelace.object.n;
            var lm_shoelace_url = "";
            if (left_shoelace_material == "{{ mat1.name }}") {
                lm_shoelace_url = "{{ mat1.file.url }}";
                left_shoelace.material.pk = "{{ mat1.pk }}";
            } else if (left_shoelace_material == "{{ mat2.name }}") {
                lm_shoelace_url = "{{ mat2.file.url }}";
                left_shoelace.material.pk = "{{ mat2.pk }}";
            } else if (left_shoelace_material == "{{ mat3.name }}") {
                lm_shoelace_url = "{{ mat3.file.url }}";
                left_shoelace.material.pk = "{{ mat3.pk }}";
            }
            left_shoelace.material.map = new THREE.TextureLoader().load(lm_shoelace_url);
        });
        lm_upper.onChange(function (jar) {
            var left_upper_material = lm_upper.object.o;
            var lm_upper_url = "";
            if (left_upper_material == "{{ mat1.name }}") {
                lm_upper_url = "{{ mat1.file.url }}";
                left_upper.material.pk = "{{ mat1.pk }}";
            } else if (left_upper_material == "{{ mat2.name }}") {
                lm_upper_url = "{{ mat2.file.url }}";
                left_upper.material.pk = "{{ mat2.pk }}";
            } else if (left_upper_material == "{{ mat3.name }}") {
                lm_upper_url = "{{ mat3.file.url }}";
                left_upper.material.pk = "{{ mat3.pk }}";
            }
            left_upper.material.map = new THREE.TextureLoader().load(lm_upper_url);
        });
        lm_tongue.onChange(function (jar) {
            var left_tongue_material = lm_tongue.object.p;
            var lm_tongue_url = "";
            if (left_tongue_material == "{{ mat1.name }}") {
                lm_tongue_url = "{{ mat1.file.url }}";
                left_tongue.material.pk = "{{ mat1.pk }}";
            } else if (left_tongue_material == "{{ mat2.name }}") {
                lm_tongue_url = "{{ mat2.file.url }}";
                left_tongue.material.pk = "{{ mat2.pk }}";
            } else if (left_tongue_material == "{{ mat3.name }}") {
                lm_tongue_url = "{{ mat3.file.url }}";
                left_tongue.material.pk = "{{ mat3.pk }}";
            }
            left_tongue.material.map = new THREE.TextureLoader().load(lm_tongue_url);
        });
        lm_bottom.onChange(function (jar) {
            var left_bottom_material = lm_bottom.object.q;
            var lm_bottom_url = "";
            if (left_bottom_material == "{{ mat1.name }}") {
                lm_bottom_url = "{{ mat1.file.url }}";
                left_bottom.material.pk = "{{ mat1.pk }}";
            } else if (left_bottom_material == "{{ mat2.name }}") {
                lm_bottom_url = "{{ mat2.file.url }}";
                left_bottom.material.pk = "{{ mat2.pk }}";
            } else if (left_bottom_material == "{{ mat3.name }}") {
                lm_bottom_url = "{{ mat3.file.url }}";
                left_bottom.material.pk = "{{ mat3.pk }}";
            }
            left_bottom.material.map = new THREE.TextureLoader().load(lm_bottom_url);
        });
        lm_sole.onChange(function (jar) {
            var left_sole_material = lm_sole.object.r;
            var lm_sole_url = "";
            if (left_sole_material == "{{ mat1.name }}") {
                lm_sole_url = "{{ mat1.file.url }}";
                left_sole.material.pk = "{{ mat1.pk }}";
            } else if (left_sole_material == "{{ mat2.name }}") {
                lm_sole_url = "{{ mat2.file.url }}";
                left_sole.material.pk = "{{ mat2.pk }}";
            } else if (left_sole_material == "{{ mat3.name }}") {
                lm_sole_url = "{{ mat3.file.url }}";
                left_sole.material.pk = "{{ mat3.pk }}";
            }
            left_sole.material.map = new THREE.TextureLoader().load(lm_sole_url);
        });

        // 右足の素材の変更時の処理
        rm_shoelace.onChange(function (jar) {
            var right_shoelace_material = rm_shoelace.object.s;
            var rm_shoelace_url = "";
            if (right_shoelace_material == "{{ mat1.name }}") {
                rm_shoelace_url = "{{ mat1.file.url }}";
                right_shoelace.material.pk = "{{ mat1.pk }}";
            } else if (right_shoelace_material == "{{ mat2.name }}") {
                rm_shoelace_url = "{{ mat2.file.url }}";
                right_shoelace.material.pk = "{{ mat2.pk }}";
            } else if (right_shoelace_material == "{{ mat3.name }}") {
                rm_shoelace_url = "{{ mat3.file.url }}";
                right_shoelace.material.pk = "{{ mat3.pk }}";
            }
            right_shoelace.material.map = new THREE.TextureLoader().load(rm_shoelace_url);
        });
        rm_upper.onChange(function (jar) {
            var right_upper_material = rm_upper.object.t;
            var rm_upper_url = "";
            if (right_upper_material == "{{ mat1.name }}") {
                rm_upper_url = "{{ mat1.file.url }}";
                right_upper.material.pk = "{{ mat1.pk }}";
            } else if (right_upper_material == "{{ mat2.name }}") {
                rm_upper_url = "{{ mat2.file.url }}";
                right_upper.material.pk = "{{ mat2.pk }}";
            } else if (right_upper_material == "{{ mat3.name }}") {
                rm_upper_url = "{{ mat3.file.url }}";
                right_upper.material.pk = "{{ mat3.pk }}";
            }
            right_upper.material.map = new THREE.TextureLoader().load(rm_upper_url);
        });
        rm_tongue.onChange(function (jar) {
            var right_tongue_material = rm_tongue.object.u;
            var rm_tongue_url = "";
            if (right_tongue_material == "{{ mat1.name }}") {
                rm_tongue_url = "{{ mat1.file.url }}";
                right_tongue.material.pk = "{{ mat1.pk }}";
            } else if (right_tongue_material == "{{ mat2.name }}") {
                rm_tongue_url = "{{ mat2.file.url }}";
                right_tongue.material.pk = "{{ mat2.pk }}";
            } else if (right_tongue_material == "{{ mat3.name }}") {
                rm_tongue_url = "{{ mat3.file.url }}";
                right_tongue.material.pk = "{{ mat3.pk }}";
            }
            right_tongue.material.map = new THREE.TextureLoader().load(rm_tongue_url);
        });
        rm_bottom.onChange(function (jar) {
            var right_bottom_material = rm_bottom.object.v;
            var rm_bottom_url = "";
            if (right_bottom_material == "{{ mat1.name }}") {
                rm_bottom_url = "{{ mat1.file.url }}";
                right_bottom.material.pk = "{{ mat1.pk }}";
            } else if (right_bottom_material == "{{ mat2.name }}") {
                rm_bottom_url = "{{ mat2.file.url }}";
                right_bottom.material.pk = "{{ mat2.pk }}";
            } else if (right_bottom_material == "{{ mat3.name }}") {
                rm_bottom_url = "{{ mat3.file.url }}";
                right_bottom.material.pk = "{{ mat3.pk }}";
            }
            right_bottom.material.map = new THREE.TextureLoader().load(rm_bottom_url);
        });
        rm_sole.onChange(function (jar) {
            var right_sole_material = rm_sole.object.w;
            var rm_sole_url = "";
            if (right_sole_material == "{{ mat1.name }}") {
                rm_sole_url = "{{ mat1.file.url }}";
                right_sole.material.pk = "{{ mat1.pk }}";
            } else if (right_sole_material == "{{ mat2.name }}") {
                rm_sole_url = "{{ mat2.file.url }}";
                right_sole.material.pk = "{{ mat2.pk }}";
            } else if (right_sole_material == "{{ mat3.name }}") {
                rm_sole_url = "{{ mat3.file.url }}";
                right_sole.material.pk = "{{ mat3.pk }}";
            }
            right_sole.material.map = new THREE.TextureLoader().load(rm_sole_url);
        });

        gui.close();
        gui.open();

    }
    var guiContainer = document.getElementById('guiContainer');
    guiContainer.appendChild(gui.domElement);
    screen.addEventListener('mouseenter', function () {
        controls.enabled = true;
    })
    screen.addEventListener('mouseout', function () {
        controls.enabled = false;
    })
    guiContainer.addEventListener('mouseenter', function () {
        controls.enabled = false;
    })
    guiContainer.addEventListener('mouseleave', function () {
        controls.enabled = true;
    })

    var ambientLight = new THREE.AmbientLight(0x888888, 0.9);
    scene.add(ambientLight);

    var shadowLight = new THREE.DirectionalLight(0xffffff, 1, 0);
    shadowLight.position.set(0, 1, 0);
    shadowLight.castShadow = true;
    scene.add(shadowLight);

    var render = function () {
        renderer.render(scene, camera);
    };

    var GameLoop = function () {
        requestAnimationFrame(GameLoop);
        render();
    };

    GameLoop();
    displaygui();
</script>

<script>
    function cameraSide() {
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 3.5;
        camera.rotation.x = 0;
        camera.rotation.y = 0;
        camera.rotation.z = 0;
        scene.rotation.x = 0;
        scene.rotation.y = 0;
        scene.rotation.y = -45 * (Math.PI / 180);
    }

    function cameraFront() {
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 3.5;
        camera.rotation.x = 0;
        camera.rotation.y = 0;
        camera.rotation.z = 0;
        scene.rotation.x = 0;
        scene.rotation.y = 0;
        scene.rotation.z = 0;
    }

    function cameraUp() {
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 3;
        camera.rotation.x = 0;
        camera.rotation.y = 0;
        camera.rotation.z = 0;
        scene.rotation.x = 1.3;
        scene.rotation.y = 0;
        scene.rotation.z = 0;
    }

    function cameraBottom() {
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 4;
        camera.rotation.x = 0;
        camera.rotation.y = 0;
        camera.rotation.z = 0;
        scene.rotation.x = -1.3;
        scene.rotation.y = 0;
        scene.rotation.z = 0;
    }

    // 確定後の処理
    var submit = document.getElementById("submit");

    var outsole_color_left = document.getElementById("id_outsole_color_left");
    var midsole_color_left = document.getElementById("id_midsole_color_left");
    var uppersole_color_left = document.getElementById("id_uppersole_color_left");
    var shoelace_color_left = document.getElementById("id_shoelace_color_left");
    var tongue_color_left = document.getElementById("id_tongue_color_left");
    var outsole_color_right = document.getElementById("id_outsole_color_right");
    var midsole_color_right = document.getElementById("id_midsole_color_right");
    var uppersole_color_right = document.getElementById("id_uppersole_color_right");
    var shoelace_color_right = document.getElementById("id_shoelace_color_right");
    var tongue_color_right = document.getElementById("id_tongue_color_right");

    var outsole_material_left = document.getElementById("id_outsole_material_left");
    var midsole_material_left = document.getElementById("id_midsole_material_left");
    var uppersole_material_left = document.getElementById("id_uppersole_material_left");
    var shoelace_material_left = document.getElementById("id_shoelace_material_left");
    var tongue_material_left = document.getElementById("id_tongue_material_left");
    var outsole_material_right = document.getElementById("id_outsole_material_right");
    var midsole_material_right = document.getElementById("id_midsole_material_right");
    var uppersole_material_right = document.getElementById("id_uppersole_material_right");
    var shoelace_material_right = document.getElementById("id_shoelace_material_right");
    var tongue_material_right = document.getElementById("id_tongue_material_right");

    var image_front = document.getElementById("id_image_data_front");
    var image_side = document.getElementById("id_image_data_side");
    var image_up = document.getElementById("id_image_data_up");
    var image_down = document.getElementById("id_image_data_down");

    $('#main-form').submit(function (e) {
        var form = this;
        e.preventDefault();
        // 色情報を取得する
        outsole_color_left.value = "#" + left_sole.material.color.getHexString();
        midsole_color_left.value = "#" + left_bottom.material.color.getHexString();
        uppersole_color_left.value = "#" + left_upper.material.color.getHexString();
        shoelace_color_left.value = "#" + left_shoelace.material.color.getHexString();
        tongue_color_left.value = "#" + left_tongue.material.color.getHexString();
        outsole_color_right.value = "#" + right_sole.material.color.getHexString();
        midsole_color_right.value = "#" + right_bottom.material.color.getHexString();
        uppersole_color_right.value = "#" + right_upper.material.color.getHexString();
        shoelace_color_right.value = "#" + right_shoelace.material.color.getHexString();
        tongue_color_right.value = "#" + right_tongue.material.color.getHexString();

        // 素材情報を取得する
        outsole_material_left.value = left_sole.material.pk;
        midsole_material_left.value = left_bottom.material.pk;
        uppersole_material_left.value = left_upper.material.pk;
        shoelace_material_left.value = left_shoelace.material.pk;
        tongue_material_left.value = left_tongue.material.pk;
        outsole_material_right.value = right_sole.material.pk;
        midsole_material_right.value = right_bottom.material.pk;
        uppersole_material_right.value = right_upper.material.pk;
        shoelace_material_right.value = right_shoelace.material.pk;
        tongue_material_right.value = right_tongue.material.pk;

        //// スクリーンショットを取る
        var canvas = document.getElementsByTagName("canvas")[0];

        document.getElementById("blur").style.display = "flex";
        setTimeout(function () {
            cameraFront();
            render();
            image_data_front = canvas.toDataURL('image/png');
            image_front.value = image_data_front;
            setTimeout(function () {
                cameraSide();
                render();
                image_data_side = canvas.toDataURL('image/png');
                image_side.value = image_data_side;
                setTimeout(function () {
                    cameraUp();
                    render();
                    image_data_up = canvas.toDataURL('image/png');
                    image_up.value = image_data_up;
                    setTimeout(function () {
                        cameraBottom();
                        render();
                        image_data_down = canvas.toDataURL('image/png');
                        image_down.value = image_data_down;
                    }, 500);
                }, 500);
            }, 500);
            setTimeout(function () {
                form.submit()
            }, 2000)
        }, 500);
    });
</script>

<script>
    $(document).ready(function () {
        // ページ機能
        var cur_page = parseInt('{{ page_obj.number }}');
        var next_page = parseInt('{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% endif %}');
        var last_page = parseInt('{{ page_obj.paginator.num_pages }}');
        $("body").on("click", "#next_page", function () {
            if (next_page == last_page) {
                $("#next_page").addClass("hidden");
            } else {
                $("#next_page").removeClass("hidden");
            }

            $.get("", { page: next_page }, function (data) {
                $("#design_list").html(data);
                cur_page += 1;
                next_page = cur_page + 1;
                if (cur_page > 1) {
                    $("#prev_page").removeClass("hidden");
                }
            });
            return false;
        });
        $("body").on("click", "#prev_page", function () {
            $("#next_page").removeClass("hidden");

            $.get("", { page: cur_page - 1 }, function (data) {
                $("#design_list").html(data);
                cur_page -= 1;
                next_page = cur_page + 1;
                if (cur_page == 1) {
                    $("#prev_page").addClass("hidden");
                }

            });
            return false;
        });

        // パレットからのデザイン反映
        $('body').on("click", ".design-form", function (e) {
            e.preventDefault();
            var pk = $(this).attr("id").split("_")[1];
            $.ajax({
                'url': $('#form_' + pk).attr('action'),
                'type': 'POST',
                'data': $('#form_' + pk).serialize(),
                'dataType': 'json',
                'success': function (response) {
                    // 色
                    left_sole.material.color = new THREE.Color(response["outsole_color_left"]);
                    left_bottom.material.color = new THREE.Color(response["midsole_color_left"]);
                    left_upper.material.color = new THREE.Color(response["uppersole_color_left"]);
                    left_shoelace.material.color = new THREE.Color(response["shoelace_color_left"]);
                    left_tongue.material.color = new THREE.Color(response["tongue_color_left"]);
                    right_sole.material.color = new THREE.Color(response["outsole_color_right"]);
                    right_bottom.material.color = new THREE.Color(response["midsole_color_right"]);
                    right_upper.material.color = new THREE.Color(response["uppersole_color_right"]);
                    right_shoelace.material.color = new THREE.Color(response["shoelace_color_right"]);
                    right_tongue.material.color = new THREE.Color(response["tongue_color_right"]);

                    // 素材
                    left_sole.material.map = new THREE.TextureLoader().load(response["outsole_material_left"]);
                    left_bottom.material.map = new THREE.TextureLoader().load(response["midsole_material_left"]);
                    left_upper.material.map = new THREE.TextureLoader().load(response["uppersole_material_left"]);
                    left_shoelace.material.map = new THREE.TextureLoader().load(response["shoelace_material_left"]);
                    left_tongue.material.map = new THREE.TextureLoader().load(response["tongue_material_left"]);
                    right_sole.material.map = new THREE.TextureLoader().load(response["outsole_material_right"]);
                    right_bottom.material.map = new THREE.TextureLoader().load(response["midsole_material_right"]);
                    right_upper.material.map = new THREE.TextureLoader().load(response["uppersole_material_right"]);
                    right_shoelace.material.map = new THREE.TextureLoader().load(response["shoelace_material_right"]);
                    right_tongue.material.map = new THREE.TextureLoader().load(response["tongue_material_right"]);
                },
                'error': function (error) {
                    console.log(error);
                }
            });
            return false;
        });
    });
</script>
{% endblock %}